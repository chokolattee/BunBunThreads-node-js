<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Product Details</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.16.1/sweetalert2.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="/css/details.css">
</head>

<body>
    <div id="header"></div>

    <div class="details-container">
        <div class="product-card">
            <div class="slider-section">
                <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-indicators" id="carouselIndicators"></div>
                    <div class="carousel-inner" id="carouselInner"></div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel"
                        data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#productCarousel"
                        data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>

            <div class="product-info">
                <div class="product-header">
                    <h3 class="product-name" id="itemName">Loading...</h3>
                    <p class="product-description" id="itemDescription"></p>
                </div>

                <div class="price-stock-section">
                    <div class="product-price">
                        <span class="price-currency">₱</span><span id="itemPrice"></span>
                    </div>
                    <div class="stock-badge">
                        <div class="stock-icon"></div>
                        <span>Stock: <span id="itemStock"></span></span>
                    </div>
                </div>

                <div class="product-actions">
                    <div class="quantity-section">
                        <span class="quantity-label">Quantity:</span>
                        <div class="quantity-selector">
                            <input type="number" id="quantityInput" class="quantity-input" min="1" value="1">
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn-add-cart" id="addToCartBtn">
                            <i class="fas fa-shopping-cart cart-icon"></i>
                            Add to Cart
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <hr class="divider">

        <div class="reviews-section">
            <div class="reviews-header">
                <h4 class="reviews-title">
                    <i class="fas fa-star"></i>
                    Customer Reviews
                    <i class="fas fa-star"></i>
                </h4>
            </div>
            <div id="reviewsContainer">
                <p class="no-reviews">Loading reviews...</p>
            </div>
        </div>
    </div>
    <div class="cart-popup" id="cartPopup">
        <div class="popup-content">
            <div class="popup-icon">
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor"
                        d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" />
                </svg>
            </div>
            <div class="popup-text">
                <h3>Added to Cart!</h3>
                <p>Your item has been successfully added to your shopping cart.</p>
            </div>
            <div class="popup-close">&times;</div>
        </div>
    </div>

    <script>
        // Helper function to check if user is logged in
        function isUserLoggedIn() {
            const token = sessionStorage.getItem('token') || localStorage.getItem('token');
            const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
            return token && userId;
        }

        // Function to show the cart popup
        function showCartPopup() {
            const popup = document.getElementById('cartPopup');
            popup.classList.add('active');

            // Auto-hide after 3 seconds
            setTimeout(() => {
                popup.classList.remove('active');
            }, 3000);
        }

        // Function to show out of stock notification
        function showOutOfStockNotification() {
            Swal.fire({
                title: "Out of Stock",
                text: "Sorry, this item is currently out of stock and cannot be added to your cart.",
                icon: "error",
                confirmButtonText: "OK"
            });
        }

        // Function to render review images
        function renderReviewImages(images) {
            if (!Array.isArray(images) || images.length === 0) return '';

            return `
                <div class="review-images" style="margin-top: 10px; display:block;">
                    ${images.map((image, index) => {
                        // Handle both full paths and just filenames
                        const imagePath = image.image_path.includes('/') 
                            ? '/images/' + image.image_path.split('/').pop() 
                            : '/images/' + image.image_path;
                        return `
                            <img src="${imagePath}" 
                                 alt="Review image ${index + 1}" 
                                 class="review-image" 
                                 style="max-width: 100px; max-height: 100px; margin: 5px; border-radius: 5px; cursor: pointer;"
                                 onclick="window.openImageModal('${imagePath}')"
                                 onerror="this.style.display='none';">
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Make openImageModal available globally
        window.openImageModal = function(imageSrc) {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'image-modal-overlay';
            modalOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            `;

            modalOverlay.innerHTML = `
                <div class="image-modal" style="position: relative; max-width: 90%; max-height: 90%;">
                    <span class="image-modal-close" style="position: absolute; top: -30px; right: -30px; color: white; font-size: 30px; cursor: pointer;">&times;</span>
                    <img src="${imageSrc}" alt="Review image" class="modal-image" style="max-width: 100%; max-height: 100%; border-radius: 10px;">
                </div>
            `;

            document.body.appendChild(modalOverlay);

            // Close modal when clicking overlay or close button
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay || e.target.classList.contains('image-modal-close')) {
                    document.body.removeChild(modalOverlay);
                }
            });
        };

        $(document).ready(() => {
            const params = new URLSearchParams(window.location.search);
            const itemId = params.get("id");

            if (!itemId) {
                console.error("No item ID provided");
                return;
            }

            // Fixed fetch URL
            fetch(`/api/item/${itemId}`)
                .then(res => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return res.json();
                })
                .then(data => {
                    console.log("Fetched data:", data);

                    // Update product info
                    document.getElementById("itemName").textContent = data.item_name || "Product";
                    document.getElementById("itemDescription").textContent = data.description || "No description available";
                    document.getElementById("itemPrice").textContent = data.sell_price || "0.00";
                    document.getElementById("itemStock").textContent = data.quantity ?? 0;

                    const imageBaseUrl = "/images/";
                    const images = Array.isArray(data.images) && data.images.length
                        ? data.images
                        : ['placeholder.jpg'];

                    // Initialize Bootstrap Carousel
                    const carouselInner = document.getElementById("carouselInner");
                    const carouselIndicators = document.getElementById("carouselIndicators");

                    // Clear any existing items
                    carouselInner.innerHTML = '';
                    carouselIndicators.innerHTML = '';

                    // Add images to carousel
                    images.forEach((img, index) => {
                        const item = document.createElement("div");
                        item.className = `carousel-item ${index === 0 ? 'active' : ''}`;

                        const imgTag = document.createElement("img");
                        imgTag.src = imageBaseUrl + img;
                        imgTag.className = "d-block w-100";
                        imgTag.alt = data.item_name;
                        imgTag.onerror = function() {
                            this.src = imageBaseUrl + 'placeholder.jpg';
                            this.onerror = null;
                        };

                        item.appendChild(imgTag);
                        carouselInner.appendChild(item);

                        const indicator = document.createElement("button");
                        indicator.type = "button";
                        indicator.dataset.bsTarget = "#productCarousel";
                        indicator.dataset.bsSlideTo = index.toString();
                        indicator.className = index === 0 ? "active" : "";
                        indicator.setAttribute("aria-current", index === 0 ? "true" : "false");
                        indicator.setAttribute("aria-label", `Slide ${index + 1}`);
                        carouselIndicators.appendChild(indicator);
                    });

                    // Handle stock and add to cart functionality
                    const quantityInput = document.getElementById("quantityInput");
                    const addToCartBtn = document.getElementById("addToCartBtn");
                    const stockQuantity = data.quantity ?? 0;

                    quantityInput.max = stockQuantity;

                    if (stockQuantity === 0) {
                        addToCartBtn.disabled = true;
                        addToCartBtn.textContent = "Out of Stock";
                        addToCartBtn.classList.add("btn-secondary");
                        addToCartBtn.classList.remove("btn-primary");
                        quantityInput.disabled = true;
                        quantityInput.value = 0;
                        document.getElementById("itemStock").innerHTML = '<span style="color: red; font-weight: bold;">Out of Stock</span>';
                    } else {
                        addToCartBtn.disabled = false;
                        addToCartBtn.textContent = "Add to Cart";
                        addToCartBtn.classList.add("btn-primary");
                        addToCartBtn.classList.remove("btn-secondary");
                        quantityInput.disabled = false;
                    }

                    // Add to Cart functionality
                    addToCartBtn.addEventListener("click", () => {
                        if (stockQuantity === 0) {
                            showOutOfStockNotification();
                            return;
                        }

                        const isLoggedIn = isUserLoggedIn();
                        if (!isLoggedIn) {
                            window.location.href = "login.html";
                            return;
                        }

                        const quantity = parseInt(quantityInput.value);
                        const availableQuantity = stockQuantity;

                        if (isNaN(quantity) || quantity < 1) {
                            Swal.fire("Oops", "Please enter a valid quantity (at least 1).", "error");
                            return;
                        }

                        if (quantity > availableQuantity) {
                            Swal.fire("Oops", `Only ${availableQuantity} items available in stock.`, "error");
                            return;
                        }

                        const cart = JSON.parse(localStorage.getItem("cart")) || [];
                        const existingItem = cart.find(item => item.id === data.item_id);

                        if (existingItem) {
                            if ((existingItem.quantity + quantity) > availableQuantity) {
                                Swal.fire("Oops", `You can't add more than ${availableQuantity} items of this product to your cart.`, "error");
                                return;
                            }
                            existingItem.quantity += quantity;
                        } else {
                            cart.push({
                                id: data.item_id,
                                item_name: data.item_name,
                                price: data.sell_price,
                                image_path: images[0],
                                quantity: quantity
                            });
                        }

                        localStorage.setItem("cart", JSON.stringify(cart));
                        showCartPopup();
                    });
                    
                    // Render Reviews
                    const reviewsContainer = document.getElementById("reviewsContainer");

                    if (!Array.isArray(data.reviews) || data.reviews.length === 0) {
                        reviewsContainer.innerHTML = "<p class='no-reviews'>No reviews yet for this product.</p>";
                    } else {
                        reviewsContainer.innerHTML = data.reviews.map(review => {
                            return `
                                <div class="review" style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                                    <div class="reviewer-info" style="margin-bottom: 10px;">
                                        <span class="reviewer-name" style="font-weight: bold; margin-right: 10px;">${review.full_name || 'Anonymous'}</span>
                                        <span class="rating" style="color: #ffa500;">${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}</span>
                                    </div>
                                    <p class="review-text" style="margin-bottom: 10px;">${review.review_text || 'No review text provided'}</p>
                                    ${renderReviewImages(review.images || [])}
                                </div>
                            `;
                        }).join('');
                    }
                })
                .catch(err => {
                    console.error("❌ Fetch error:", err);
                    document.getElementById("itemName").textContent = "Product not found";
                    document.getElementById("itemDescription").textContent = "We couldn't find the product you're looking for";
                    document.getElementById("itemPrice").textContent = "--";
                    document.getElementById("itemStock").textContent = "--";
                    document.getElementById("reviewsContainer").innerHTML = "<p class='no-reviews'>Unable to load product reviews.</p>";
                });

            // Close button functionality for cart popup
            document.querySelector('.popup-close')?.addEventListener('click', () => {
                document.getElementById('cartPopup').classList.remove('active');
            });
        });

        function showSuccessNotification(itemName, quantity) {
            const popup = document.getElementById('cartPopup');
            const popupText = popup.querySelector('.popup-text p');

            if (popupText) {
                popupText.textContent = `${quantity} ${itemName} has been successfully added to your cart.`;
            }

            popup.classList.add('active');

            setTimeout(() => {
                popup.classList.remove('active');
            }, 3000);
        }
    </script>

    <script>
        $(function () {
            $("#header").load("header.html");
        });
        
        function saveCart(cart) {
            localStorage.setItem("cart", JSON.stringify(cart));
        }
    </script>
</body>

</html>