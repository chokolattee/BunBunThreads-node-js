<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Search Results</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  
  <!-- Bootstrap Icons & FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

 <link rel="stylesheet" href="css/search.css">
</head>
<body>
  <!-- Inject the header.html -->
  <div id="header"></div>

  <!-- Search Header Section -->
  <div class="search-header">
    <div class="container text-center">
      <h1 class="search-title">
        <i class="fas fa-search me-3"></i>Search Results
      </h1>
      <div class="search-term">
        <i class="fas fa-quote-left me-2"></i>
        <span id="search-term">Loading...</span>
        <i class="fas fa-quote-right ms-2"></i>
      </div>
    </div>
  </div>

  <!-- Results Container -->
  <div class="container results-container">
    <div class="row" id="searchResults">
      <!-- Loading spinner will show here initially -->
      <div class="loading">
        <div class="spinner"></div>
      </div>
    </div>
  </div>

  <script>
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // Check if user is logged in
    function isUserLoggedIn() {
      const token = localStorage.getItem('token');
      const userId = localStorage.getItem('userId');
      return !!(token && userId);
    }

    // Save cart to localStorage
    function saveCart(cart) {
      localStorage.setItem("cart", JSON.stringify(cart));
      updateCartCount();
    }

    // Show cart popup (you can customize this)
    function showCartPopup() {
      // Removed notification - just for cart count update
    }
  
    $(document).ready(function () {
      // Load the header first
      $('#header').load('/header.html', function () {
        // ðŸ” Re-run the login logic inside the callback
        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('userId');
  
        if (token && userId) {
          $('#login-link, #register-link').addClass('d-none');
          $('#user-dropdown').removeClass('d-none');
  
          $.get(`/api/users/customers/${userId}`, function (res) {
            if (res.success && res.data) {
              const data = res.data;
              const fullName = `${data.fname || ''} ${data.lname || ''}`.trim();
              $('#username').text(fullName || 'USER');
              if (data.image_path) {
                $('.profile-img').attr('src', `/${data.image_path}`);
              }
            }
          });
        } else {
          $('#login-link, #register-link').removeClass('d-none');
          $('#user-dropdown').addClass('d-none');
        }

        // Update cart count on page load
        updateCartCount();
      });
  
      // Search result handling
      const term = getQueryParam('term');
      $('#search-term').text(term || 'All Items');
  
      $.get(`/api/item/search/${term}`, function (res) {
        if (res.status === 'success' && res.data.length > 0) {
          let html = '';
          res.data.forEach((item, index) => {
            const images = item.images || [];
            const imgContent = images.length > 0
              ? `<img src="/images/${images[0]}" class="card-img-top" alt="${item.item_name}">`
              : '<div class="no-image"><div><i class="fas fa-image"></i><br>No Image Available</div></div>';
  
            html += `
              <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="card product-card mb-4">
                  <div class="card-img-container">
                    ${imgContent}
                  </div>
                  <div class="card-body">
                    <h5 class="card-title">${item.item_name}</h5>
                    <div class="price">â‚±${parseFloat(item.sell_price).toFixed(2)}</div>
                    <div class="card-buttons">
                      <button class="btn btn-outline-primary btn-sm details-btn" 
                        onclick="viewDetails(${item.item_id})">
                        <i class="fas fa-eye me-1"></i>Details
                      </button>
                      <button class="btn btn-primary btn-sm add-to-cart-btn"
                        data-id="${item.item_id}" 
                        data-name="${item.item_name}" 
                        data-price="${item.sell_price}"
                        data-quantity="${item.quantity || 1}"
                        data-image="${images.length > 0 ? images[0] : ''}">
                        <i class="fas fa-cart-plus me-1"></i>Add to Cart
                      </button>
                    </div>
                  </div>
                </div>
              </div>`;
          });
  
          $('#searchResults').html(html);
          
          // Initialize cart functionality after HTML is loaded
          initializeCartButtons();
          
        } else {
          $('#searchResults').html(`
            <div class="col-12">
              <div class="no-results">
                <i class="fas fa-search-minus"></i>
                <h4>No Results Found</h4>
                <p>Sorry, we couldn't find any items matching "${term}". Try searching with different keywords.</p>
              </div>
            </div>
          `);
        }
      }).fail(function() {
        $('#searchResults').html(`
          <div class="col-12">
            <div class="no-results">
              <i class="fas fa-exclamation-triangle"></i>
              <h4>Search Error</h4>
              <p>There was an error performing your search. Please try again later.</p>
            </div>
          </div>
        `);
      });
    });

    // View details function
    function viewDetails(itemId) {
      window.location.href = `/details.html?id=${itemId}`;
    }

    // Initialize cart functionality with localStorage approach
    function initializeCartButtons() {
      $('.add-to-cart-btn').off('click').on('click', function() {
        const button = $(this);
        const itemId = parseInt(button.data('id'));
        const itemName = button.data('name');
        const itemPrice = parseFloat(button.data('price'));
        const itemImage = button.data('image');
        const availableQuantity = parseInt(button.data('quantity')) || 1;

        // Check if user is logged in
        if (!isUserLoggedIn()) {
          Swal.fire({
            title: 'Login Required',
            text: 'Please login to add items to cart',
            icon: 'warning',
            confirmButtonText: 'Go to Login'
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = 'login.html';
            }
          });
          return;
        }

        // Add loading state
        const originalText = button.html();
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Adding...');

        // Add to cart with localStorage
        addToCartLocalStorage(itemId, itemName, itemPrice, itemImage, availableQuantity, button, originalText);
      });
    }

    // Add to cart function using localStorage
    function addToCartLocalStorage(itemId, itemName, itemPrice, itemImage, availableQuantity, button, originalText) {
      try {
        const quantity = 1; // Default quantity for search results
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const existingItem = cart.find(item => item.id === itemId);

        if (existingItem) {
          if ((existingItem.quantity + quantity) > availableQuantity) {
            Swal.fire("Oops", `You can't add more than ${availableQuantity} items of this product to your cart.`, "error");
            button.prop('disabled', false).html(originalText);
            return;
          }
          existingItem.quantity += quantity;
        } else {
          cart.push({
            id: itemId,
            item_name: itemName,
            price: itemPrice,
            image_path: itemImage,
            quantity: quantity
          });
        }

        // Save cart
        saveCart(cart);
        
        // Show success feedback on button
        button.html('<i class="fas fa-check me-1"></i>Added!').addClass('btn-success');
        
        // Reset button after 2 seconds
        setTimeout(() => {
          button.prop('disabled', false).html(originalText).removeClass('btn-success');
        }, 2000);

      } catch (error) {
        console.error('Add to cart error:', error);
        Swal.fire("Error", "Failed to add item to cart. Please try again.", "error");
        button.prop('disabled', false).html(originalText);
      }
    }

    // Update cart count function for localStorage
    function updateCartCount() {
      try {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
        
        // Update cart count in header if element exists
        if ($('.cart-count').length > 0) {
          $('.cart-count').text(totalItems);
        }
        if ($('#itemCount').length > 0) {
          $('#itemCount').text(totalItems).css('display', totalItems > 0 ? 'block' : 'none');
        }
        
      } catch (error) {
        console.error('Error updating cart count:', error);
      }
    }

    // Show alert function (keeping your existing one as fallback)
    function showAlert(message, type = 'info') {
      const alertTypes = {
        'success': { class: 'alert-success', icon: 'fa-check-circle' },
        'error': { class: 'alert-danger', icon: 'fa-exclamation-circle' },
        'warning': { class: 'alert-warning', icon: 'fa-exclamation-triangle' },
        'info': { class: 'alert-info', icon: 'fa-info-circle' }
      };

      const alertType = alertTypes[type] || alertTypes['info'];
      
      // Remove existing alerts
      $('.custom-alert').remove();
      
      // Create alert
      const alertHtml = `
        <div class="alert ${alertType.class} alert-dismissible fade show custom-alert" 
             style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
          <i class="fas ${alertType.icon} me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      
      $('body').append(alertHtml);
      
      // Auto dismiss after 5 seconds
      setTimeout(() => {
        $('.custom-alert').alert('close');
      }, 5000);
    }

    // CSS for card buttons (add this to your CSS file or in a <style> tag)
    const cardButtonsCSS = `
      <style>
        .card-buttons {
          display: flex;
          gap: 8px;
          margin-top: 10px;
        }
        
        .card-buttons .btn {
          flex: 1;
          font-size: 0.875rem;
          padding: 0.375rem 0.5rem;
        }
        
        .details-btn {
          border-color: #6c757d;
          color: #6c757d;
        }
        
        .details-btn:hover {
          background-color: #6c757d;
          border-color: #6c757d;
          color: white;
        }
        
        .add-to-cart-btn:disabled {
          opacity: 0.7;
        }
        
        .custom-alert {
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          border: none;
        }
        
        @media (max-width: 576px) {
          .card-buttons {
            flex-direction: column;
          }
          
          .custom-alert {
            left: 20px;
            right: 20px;
            min-width: auto;
          }
        }
      </style>
    `;
    
    // Inject CSS
    $('head').append(cardButtonsCSS);
  </script>
  
  <!-- Bootstrap Bundle with Popper (Required for dropdowns) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Bootstrap Bundle with Popper (Required for dropdowns) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>